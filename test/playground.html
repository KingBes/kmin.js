<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简易 KMin Playground</title>
    <script src="../src/kmin.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@wangeditor/editor@5.1.23/dist/css/style.css">
    <script src="https://unpkg.com/@wangeditor/editor@5.1.23/dist/index.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .container {
                flex-direction: row;
            }

            .editor,
            .preview {
                flex: 1;
            }
        }

        .editor,
        .preview {
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 15px;
        }

        textarea {
            box-sizing: border-box;
            width: 100%;
            height: 400px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
        }

        .controls {
            margin: 10px 0;
        }

        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        .preview-content {
            min-height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }

        .error {
            color: #dc3545;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            background-color: #f8d7da;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: 0;
        }

        #toolbar-container {
            display: none;
        }

        .w-e-bar {
            display: none !important;
        }

        #w-e-element-4 {
            display: none;
        }

        #code {
            display: none;
        }
    </style>
</head>

<body>
    <h1>KMin 简易 Playground</h1>

    <div class="container">

        <div class="preview">
            <h3>预览效果</h3>
            <div id="preview" class="preview-content">
                <iframe id="preview-iframe"></iframe>
            </div>
        </div>

        <div class="editor">
            <h3>代码编辑器</h3>
            <div id="editor-container"></div>
            <textarea id="code"></textarea>
            <div class="controls">
                <button id="run">运行</button>
            </div>
            <div id="error" class="error" style="display: none;"></div>
        </div>
    </div>

    <script>
        const { createEditor, createToolbar } = window.wangEditor;
        const codeTextarea = document.getElementById('code');

        const runButton = document.getElementById('run');
        const preview = document.getElementById('preview');
        const errorDisplay = document.getElementById('error');

        let isInit = false;

        // 配置编辑器
        const editorConfig = {
            placeholder: '只能输入JavaScript代码...',
            onChange(editor) {
                const html = editor.getText();
                codeTextarea.value = html;
                if (!isInit) {
                    isInit = true;
                    runButton.click();
                }
            },
            // 扩展配置
            extendConfig: {
                // 只允许pre和code标签
                allowElems: ['pre', 'code'],
                // 禁止样式
                styleWithCSS: false,
                // 粘贴时过滤样式
                pasteFilterStyle: true,
                // 忽略粘贴的图片
                pasteIgnoreImg: true,
                // 处理粘贴的文本：转换为代码块
                pasteTextHandle: content => {
                    // 将粘贴的文本内容转换为代码块格式
                    return `<pre><code class="language-javascript">${content}</code></pre>`;
                }
            }
        };

        // 创建编辑器
        const editor = createEditor({
            selector: '#editor-container',
            config: editorConfig,
            html: `<pre><code class="language-javascript">// Hello World 示例
class HelloComponent extends KMin {
    constructor() {
        super();
        // 定义动态数据
        this.data = this.state({
            count: 0,
            name: 'kmin'
        })
    }
    // 增加
    increment() {
        this.data.count++;
    }
    // 减少
    decrement() {
        this.data.count--;
    }
    // 重置
    reset() {
        this.data.count = 0;
    }
    // css
    css() {
        return \`
        span{
            color: red;
        }
        \`
    }
    render() {
        return \`
            &lt;h2&gt;hello {{data.name}}&lt;/h2&gt;
            &lt;div class="counter"&gt;
                &lt;button @click="decrement"&gt;-&lt;/button&gt;
                &lt;span&gt;Count: {{data.count}}&lt;/span&gt;
                &lt;button @click="increment"&gt;+&lt;/button&gt;
            &lt;/div&gt;
            &lt;button @click="reset"&gt;Reset&lt;/button&gt;
        \`;
    }
}
customElements.define('hello-component', HelloComponent);
                </code></pre>`, // 初始内容设置为代码块
            mode: 'default'
        });

        runButton.addEventListener('click', () => {
            // 隐藏错误信息
            errorDisplay.style.display = 'none';
            errorDisplay.textContent = '';
            const code = codeTextarea.value;
            try {
                preview.innerHTML = '';
                const TagName = code.match(/customElements.define\(['"]([\w-]+)['"],/)[1];
                const Bodys = `
                <!DOCTYPE html>
                <html>
                    <body>
                        <${TagName}><\/${TagName}>
                        <script src="..\/src\/kmin.js"><\/script>
                        <script type="module">
                            ${code}
                        <\/script>
                    <\/body>
                <\/html>`
                const iframe = document.createElement('iframe');
                preview.appendChild(iframe);
                iframe.contentDocument?.write(Bodys)
                iframe.contentDocument?.close()
                // 获取 iframe 报错信息
                const iframeError = iframe.contentWindow?.error;
                if (iframeError) {
                    errorDisplay.style.display = 'block';
                    errorDisplay.textContent = `错误: ${iframeError}`;
                }
            } catch (err) {
                // 显示错误信息
                errorDisplay.style.display = 'block';
                errorDisplay.textContent = `错误: ${err.message}`;
                console.log('err', err);
            }
        });

        // 初始运行示例代码
        // runButton.click();
    </script>
</body>

</html>